rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════
    // HELPERS
    // ═══════════════════════════════════════

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return request.auth.uid == uid;
    }

    // ═══════════════════════════════════════
    // USERS
    // ═══════════════════════════════════════
    match /users/{uid} {
      // Любой авторизованный может читать профили (discover, search, chats)
      allow read: if isSignedIn();

      // Создание / удаление — только владелец
      allow create: if isOwner(uid);
      allow delete: if isOwner(uid);

      // Обновление:
      //  - владелец может менять что угодно
      //  - другой авторизованный может менять ТОЛЬКО рейтинг/баллы (submitReview транзакция)
      allow update: if isOwner(uid)
        || (isSignedIn()
            && request.resource.data.diff(resource.data).affectedKeys()
               .hasOnly(['ratingAvg', 'ratingCount', 'rating', 'points']));

      // --- likes ---
      // get: владелец ИЛИ тот, на кого лайк (для проверки взаимности)
      // list: только владелец (getLikedUserIds)
      // write: только владелец
      match /likes/{otherUid} {
        allow get:   if isOwner(uid) || request.auth.uid == otherUid;
        allow list:  if isOwner(uid);
        allow write: if isOwner(uid);
      }

      // --- passes ---
      // полностью приватно
      match /passes/{otherUid} {
        allow read, write: if isOwner(uid);
      }
    }

    // ═══════════════════════════════════════
    // MATCHES
    // ═══════════════════════════════════════
    match /matches/{matchId} {
      allow read: if isSignedIn()
        && request.auth.uid in resource.data.users;

      allow create: if isSignedIn()
        && request.auth.uid in request.resource.data.users
        && request.resource.data.users.size() == 2;

      // update разрешён только участникам, users менять нельзя
      // (нужен для setData(merge:true) при создании матча)
      allow update: if isSignedIn()
        && request.auth.uid in resource.data.users
        && request.resource.data.users == resource.data.users;

      allow delete: if false;
    }

    // ═══════════════════════════════════════
    // CHATS
    // ═══════════════════════════════════════
    match /chats/{chatId} {
      allow read: if isSignedIn()
        && request.auth.uid in resource.data.users;

      allow create: if isSignedIn()
        && request.auth.uid in request.resource.data.users
        && request.resource.data.users.size() == 2;

      // update: участники, но users менять нельзя (lastMessage, lastMessageAt, lastSenderId)
      allow update: if isSignedIn()
        && request.auth.uid in resource.data.users
        && request.resource.data.users == resource.data.users;

      allow delete: if false;

      // --- messages ---
      match /messages/{messageId} {
        allow read: if isSignedIn()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.users;

        allow create: if isSignedIn()
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.users
          && request.resource.data.senderId == request.auth.uid;

        allow update, delete: if false;
      }
    }

    // ═══════════════════════════════════════
    // SESSIONS
    // ═══════════════════════════════════════
    match /sessions/{sessionId} {
      allow read: if isSignedIn()
        && request.auth.uid in resource.data.users;

      allow create: if isSignedIn()
        && request.auth.uid in request.resource.data.users
        && request.resource.data.users.size() == 2;

      // update: участники, users менять нельзя
      allow update: if isSignedIn()
        && request.auth.uid in resource.data.users
        && request.resource.data.users == resource.data.users;

      allow delete: if false;

      // --- reviews ---
      match /reviews/{reviewerUid} {
        allow read: if isSignedIn()
          && request.auth.uid in get(/databases/$(database)/documents/sessions/$(sessionId)).data.users;

        allow create: if isSignedIn()
          && reviewerUid == request.auth.uid
          && request.auth.uid in get(/databases/$(database)/documents/sessions/$(sessionId)).data.users
          && request.resource.data.stars is int
          && request.resource.data.stars >= 1
          && request.resource.data.stars <= 5
          && request.resource.data.text is string
          && request.resource.data.text.size() <= 200;

        allow update, delete: if false;
      }
    }

    // ═══════════════════════════════════════
    // DEBUG
    // ═══════════════════════════════════════
    match /debug/{docId} {
      allow read, write: if isSignedIn();
    }
  }
}
